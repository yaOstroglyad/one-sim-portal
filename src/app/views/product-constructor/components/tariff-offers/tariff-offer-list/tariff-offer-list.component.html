<app-header class="os-header-sticky"
            [formGroup]="filterForm"
            [tableConfig$]="tableConfig$"
            (onAddAction)="onCreateNew()"
            (columnSelectionChange)="onColumnSelectionChanged($event)">
    <ng-container header-custom-inputs>
        <input cFormControl formControlName="productName" [type]="'text'" placeholder="{{ 'tariffOffer.productName' | translate }}">
        <input cFormControl formControlName="providerProductName" [type]="'text'" placeholder="{{ 'tariffOffer.providerProductName' | translate }}">
        <button cButton
                color="secondary"
                [disabled]="filterForm.pristine"
                (click)="resetForm()">
            <svg cIcon name="cilReload"></svg>
        </button>
    </ng-container>
</app-header>

<generic-table [config$]="tableConfig$"
               [menu]="menuTemplate"
               [data$]="tariffOffers$"
               [isRowClickable]="true"
               (onRowClickEvent)="onViewDetails($event)"
               (pageChange)="onPageChange($event)">
</generic-table>

<!-- Custom template for price column -->
<ng-template #priceTemplate let-data='context'>
    <td class="text-end">
        <span class="fw-bold">{{ data.price | currency:data.currency:'symbol':'1.2-2' }}</span>
    </td>
</ng-template>

<!-- Custom template for status column -->
<ng-template #statusTemplate let-data='context'>
    <td class="text-center">
        <c-badge [color]="data.active ? 'success' : 'danger'"
                 shape="rounded-pill">
            {{ data.active ? 'Active' : 'Inactive' }}
        </c-badge>
    </td>
</ng-template>

<ng-template #menuTemplate let-item>
    <button mat-icon-button [matMenuTriggerFor]="menu" (click)="$event.stopPropagation();">
        <mat-icon>more_vert</mat-icon>
    </button>
    <mat-menu #menu="matMenu">
        <button mat-menu-item (click)="onViewDetails(item)">
            <mat-icon>visibility</mat-icon>
            <span>{{ 'common.view' | translate }} Details</span>
        </button>
        <button mat-menu-item (click)="onEdit(item)">
            <mat-icon>edit</mat-icon>
            <span>{{ 'common.edit' | translate }}</span>
        </button>
        <button mat-menu-item (click)="onDelete(item)">
            <mat-icon>delete</mat-icon>
            <span>Delete</span>
        </button>
    </mat-menu>
</ng-template>

<!-- Create Panel -->
<app-generic-right-panel
  *ngIf="showCreatePanel"
  title="Create Tariff Offer"
  subtitle="Create a new tariff offer by linking a product with a provider product"
  [isOpen]="showCreatePanel"
  [hasFooter]="true"
  (close)="onPanelClose()">

  <div panel-content>
    <app-tariff-offer-form
      #createForm
      [tariffOffer]="null"
      [hideActions]="true"
      (save)="onTariffOfferSaved()">
    </app-tariff-offer-form>
  </div>

  <ng-container panel-actions>
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="onPanelClose()">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="createForm.onSubmit()"
      [disabled]="createForm.loading || createForm.tariffOfferForm?.invalid">
      <span *ngIf="createForm.loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      Create Tariff Offer
    </button>
  </ng-container>

</app-generic-right-panel>

<!-- Edit Panel -->
<app-generic-right-panel
  *ngIf="showEditPanel && selectedTariffOffer"
  title="Edit Tariff Offer"
  subtitle="Update tariff offer pricing and settings"
  [isOpen]="showEditPanel"
  [hasFooter]="true"
  (close)="onPanelClose()">

  <div panel-content>
    <app-tariff-offer-form
      #editForm
      [tariffOffer]="selectedTariffOffer"
      [hideActions]="true"
      (save)="onTariffOfferSaved()">
    </app-tariff-offer-form>
  </div>

  <ng-container panel-actions>
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="onPanelClose()">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-primary"
      (click)="editForm.onSubmit()"
      [disabled]="editForm.loading || editForm.tariffOfferForm?.invalid">
      <span *ngIf="editForm.loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      Update Tariff Offer
    </button>
  </ng-container>

</app-generic-right-panel>

<!-- Details Panel -->
<app-generic-right-panel
  *ngIf="showDetailsPanel && selectedTariffOfferDetails"
  title="Tariff Offer Details"
  [isOpen]="showDetailsPanel"
  [actions]="detailsPanelActions"
  [resizable]="true"
  [defaultWidth]="600"
  [maxWidth]="900"
  (close)="onPanelClose()">

  <div panel-content>
    <app-tariff-offer-details [tariffOffer]="selectedTariffOfferDetails"></app-tariff-offer-details>
  </div>

</app-generic-right-panel>

<!-- Delete Confirmation Panel -->
<app-generic-right-panel
  *ngIf="showDeletePanel && selectedTariffOffer"
  title="Confirm Delete"
  [isOpen]="showDeletePanel"
  [defaultWidth]="450"
  [resizable]="false"
  [hasFooter]="true"
  (close)="onPanelClose()">

  <div panel-content>
    <app-delete-confirmation
      [config]="{
        itemName: selectedTariffOffer.product?.name + ' - ' + selectedTariffOffer.providerProduct?.serviceCoverage?.name,
        itemType: 'Tariff Offer',
        warningMessage: 'This action cannot be undone. This tariff offer will be permanently removed.'
      }"
      (confirm)="onConfirmDelete()"
      (cancel)="onPanelClose()">
    </app-delete-confirmation>
  </div>

  <ng-container panel-actions>
    <button
      type="button"
      class="btn btn-outline-secondary"
      (click)="onPanelClose()">
      Cancel
    </button>
    <button
      type="button"
      class="btn btn-danger"
      (click)="onConfirmDelete()">
      Delete Tariff Offer
    </button>
  </ng-container>

</app-generic-right-panel>
